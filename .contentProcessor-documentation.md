# ContentProcessor.ts Documentation

## Overview

The `contentProcessor.ts` file is a core utility module that enhances markdown content processing for the Next.js blog system. It extends the default remark markdown processor with custom plugins to provide advanced image handling and link processing capabilities.

## Location
`src/lib/contentProcessor.ts`

## Dependencies

- **remark**: Core markdown processing library
- **remark-html**: Converts markdown AST to HTML
- **remark-external-links**: External link enhancement plugin
- **unist-util-visit**: Tree traversal utility for AST manipulation
- **unist**: TypeScript definitions for unified syntax trees

## Architecture

The module follows a plugin-based architecture using remark's unified system, implementing custom transformers that modify the markdown Abstract Syntax Tree (AST) before HTML conversion.

## Core Functions

### 1. `processArticleContent(content: string): Promise<string>`

**Purpose**: Main export function that processes markdown content through the complete enhancement pipeline.

**Process Flow**:
1. Initializes remark processor
2. Applies plugins in sequence:
   - `remarkExternalLinks` - Enhances external links with security attributes
   - `remarkImageEnhancer()` - Processes custom image syntax
3. Converts to HTML with sanitization disabled
4. Returns processed HTML string

**Usage**: Called by `getBlogData()` in `blog.ts` to transform raw markdown content into enhanced HTML.

```typescript
const contentHtml = await processArticleContent(matterResult.content)
```

### 2. External Link Processing

**Implementation**: Uses the `remark-external-links` plugin for automatic external link enhancement.

**Configuration**:
```typescript
.use(remarkExternalLinks, { target: "_blank", rel: ["noopener", "noreferrer"] })
```

**Functionality**:
- Automatically detects external URLs (http/https/protocol-relative)
- Adds `target="_blank"` for new tab opening
- Adds `rel="noopener noreferrer"` for security
- Preserves all original link attributes and content
- No custom code maintenance required

**Security Benefits**:
- **`rel="noopener"`**: Prevents malicious sites from accessing `window.opener`
- **`rel="noreferrer"`**: Blocks referrer header transmission for privacy
- **`target="_blank"`**: Opens external links in new tabs

### 3. `remarkImageEnhancer()`

**Purpose**: Advanced image processing plugin that parses custom markdown syntax for enhanced image display options.

**Custom Syntax Support**:
```markdown
![Description|option1:value1|option2:value2](image-url)
```

**Supported Options**:
- `style`: Layout styles (full-width, centered, float-right, etc.)
- `size`: Size variants (small, medium, large)
- `caption`: Figure captions
- `border`: Border styles
- `shadow`: Shadow effects
- `hover`: Interactive hover effects
- `effect`: Special visual effects
- `align`: Alignment options
- `spacing`: Spacing controls

**Output**: Generates structured HTML with wrapper divs, CSS classes, and optional captions.

### 4. Helper Functions

#### `generateImageClasses(options: Record<string, string>): string`
- Maps image options to CSS class names
- Follows consistent naming convention (`image-*`, `image-hover-*`)
- Returns space-separated class string

#### `generateWrapperClasses(options: Record<string, string>): string`
- Generates wrapper div classes for layout control
- Handles alignment and spacing options
- Returns space-separated class string

## TypeScript Interfaces

### `ImageNode extends Node`
- `type: 'image'`
- `url: string` - Image source URL
- `alt: string` - Alt text with custom syntax
- `title?: string` - Optional title attribute

### `ParagraphNode extends Node`
- `type: 'paragraph'`
- `children: Node[]` - Child nodes

## Usage Throughout Project

### Primary Integration
**File**: `src/lib/blog.ts`
**Function**: `getBlogData(slug: string)`
```typescript
import { processArticleContent } from '@/lib/contentProcessor'
// ...
const contentHtml = await processArticleContent(matterResult.content)
```

### Content Flow
1. **Raw Markdown** → Fetched from GitHub content repository
2. **Front Matter Parsing** → Extracted in `blog.ts`
3. **Content Processing** → Enhanced via `processArticleContent()`
4. **HTML Output** → Rendered in React components

## CSS Class Requirements

The enhanced HTML output requires corresponding CSS classes in `globals.css`:

```css
/* Image wrapper classes */
.image-wrapper { /* base wrapper styles */ }
.wrapper-full-width { /* full width layout */ }
.wrapper-centered { /* centered layout */ }
.wrapper-float-right { /* floating layout */ }

/* Image classes */
.article-image { /* base image styles */ }
.image-small, .image-medium, .image-large { /* size variants */ }
.image-border-rounded { /* border styles */ }
.image-shadow-lg { /* shadow effects */ }
.image-hover-zoom { /* hover interactions */ }

/* Caption styles */
.image-caption { /* figure caption styling */ }
```

## Examples

### Enhanced Links
**Input**: `[External Site](https://example.com)`
**Output**: `<a href="https://example.com" target="_blank" rel="noopener noreferrer">External Site</a>`

### Custom Images
**Input**: `![Chart showing growth|style:full-width|caption:Revenue data 2024](chart.png)`
**Output**:
```html
<div class="image-wrapper wrapper-full-width">
  <img src="chart.png" alt="Chart showing growth" class="article-image image-full-width" loading="lazy" />
  <figcaption class="image-caption">Revenue data 2024</figcaption>
</div>
```

## Performance Considerations

- **Lazy Loading**: All images include `loading="lazy"` attribute
- **AST Processing**: Efficient tree traversal using `unist-util-visit`
- **Sanitization**: Disabled HTML sanitization for custom enhancements
- **Async Processing**: Supports Node.js async/await patterns

## Security Measures

- **External Link Protection**: Automatic `rel="noopener noreferrer"`
- **HTML Injection Prevention**: Controlled HTML generation
- **URL Validation**: Protocol-based external link detection

## Extensibility

The plugin architecture allows easy addition of new processors:
1. Create new plugin function
2. Add to remark processing chain
3. Define corresponding CSS classes
4. Update TypeScript interfaces as needed

This system provides a flexible foundation for advanced markdown content enhancement while maintaining security and performance standards.